name: 备份多个仓库

于:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: 检出备份仓库
        # 检出本仓库代码到工作目录，用于提交数据
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}

      - name: 克隆并整理外部仓库
        # 批量拉取待备份的外部仓库，并统一保存在特定目录
        shell: bash
        run: |
          # 定义仓库列表，每行格式为：仓库地址 目标文件夹
          repos=(
            "https://github.com/ACL4SSR/ACL4SSR ACL4SSR(ACL4SSR)"
            "https://github.com/xiaomaoJT/QxScript QxScript(xiaomaoJT)"
            "https://github.com/blackmatrix7/ios_rule_script ios_rule_script(blackmatrix7)"
            "https://github.com/NobyDa/Script Script(NobyDa)"
            "https://github.com/limbopro/Adblock4limbo Adblock4limbo(limbopro)"
            "https://github.com/VirgilClyne/iRingo iRingo(VirgilClyne)"
            "https://github.com/app2smile/rules rules(app2smile)"
            "https://github.com/Semporia/TikTok-Unlock TikTok-Unlock(Semporia)"
            "https://github.com/deezertidal/QuantumultX-Rewrite QuantumultX-Rewrite(deezertidal)"
            "https://github.com/TributePaulWalker/Profiles Profiles(TributePaulWalker)"
            "https://github.com/zqzess/rule_for_quantumultX rule_for_quantumultX(zqzess)"
            "https://github.com/89996462/Quantumult-X Quantumult-X(89996462)"
            "https://github.com/ddgksf2013/ddgksf2013 ddgksf2013(ddgksf2013)"
            "https://github.com/ddgksf2013/Profile Profile(ddgksf2013)"
            "https://github.com/ddgksf2013/Rewrite Rewrite(ddgksf2013)"
            "https://github.com/ddgksf2013/Filter Filter(ddgksf2013)"
            "https://github.com/ddgksf2013/Scripts Scripts(ddgksf2013)"
            "https://github.com/Yu9191/Rewrite Rewrite(Yu9191)"
            "https://github.com/Marol62926/Quantumultx Quantumultx(Marol62926)"
            "https://github.com/Marol62926/MarScrpt MarScrpt(Marol62926)"
            "https://github.com/fmz200/wool_scripts wool_scripts(fmz200)"
            "https://github.com/Repcz/Tool Tool(Repcz)"
            # "https://github.com/chxm1023/Rewrite Rewrite(chxm1023)" # 如需恢复，去掉前面的#
            "https://github.com/GeQ1an/Rules Rules(GeQ1an)"
          )

          for entry in "${repos[@]}"; do
            repo_url=$(echo "$entry" | awk '{print $1}')
            target_dir=$(echo "$entry" | awk '{print $2}')
            tmp_dir=$(basename "$repo_url" | sed 's/.git$//')_tmp
            # 对部分需要指定分支的仓库做单独处理
            branch_opt=""
            if [[ "$repo_url" == *GeQ1an/Rules* || "$repo_url" == *ACL4SSR/ACL4SSR* ]]; then
              branch_opt="--branch master"
            fi
            # 克隆仓库（只拉取最新，节省空间和流量）
            git clone --depth=1 $branch_opt "$repo_url" "$tmp_dir"
            # 清理旧目录，创建目标目录，并移动内容
            rm -rf "$target_dir"
            mkdir -p "$target_dir"
            mv "$tmp_dir"/* "$target_dir"/ 2>/dev/null || true
            rm -rf "$tmp_dir"
          done

      - name: 更新时间戳文件
        # 用于记录最近一次备份的时间
        run: echo "备份运行时间: $(date)" > backup-timestamp.txt

      - name: 提交并推送变更
        # 自动提交备份内容并推送到github
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff-index --quiet HEAD; then
            echo "无内容变更，仅更新时间戳文件。"
            echo "备份运行时间: $(date)" > backup-timestamp.txt
            git add backup-timestamp.txt
            git commit -m "$(date +'%Y-%m-%d %H:%M:%S')"
          else
            git commit -m "自动备份 $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          git remote set-url origin https://x-access-token:${PAT}@github.com/smjcxf/pz.git
          git push origin main
